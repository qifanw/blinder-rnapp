#!/bin/bash
# 安装依赖
npm install
# 执行单元测试
npm test
# 获取版本号
version=`cat package.json | grep version | awk -F \" '{print $4}'`
# 替换版本号
sed -i s/version/$version/g ./README.MD

# 发布到cnpm
if [ "$2"x = "tag"x ]; then
    # tag版本，直接发布
    cnpm publish
else
    # 非tag版本，将版本号后面增加snapshot后缀后发布
    oldVersion=$version
    version=$oldVersion-snapshot
    sed -i s/$oldVersion/$version/g package.json
    # 由于cnpm发布重复的版本不会覆盖，只会报错，所以如果存在对应的snapshot版本，则unpublish
    cnpm unpublish @jhjr/$1/@$version
    # 发布snapshot版本
    cnpm publish
    # 恢复package.json
    sed -i s/$version/$oldVersion/g package.json
fi


# 替换版本号
sed -i s/version/$version/g ./README.MD
# 生成jsdoc
jsdoc -c jsdoc.json
# jsdoc文档
source=./out/*
# 分发目录
dist=/var/jsdoc/$1/$version/
# 避免文件夹不存在，强制创建
mkdir -vp $dist
# 将jsdoc文档发布到分发目录
cp -R -f $source $dist