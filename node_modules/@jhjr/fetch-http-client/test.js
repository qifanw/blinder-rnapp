/**
 * Created by ztian on 16/7/13.
 */
// 单元测试在nodejs环境下进行，所以依赖node-fetch和form-data库
global.fetch = require('node-fetch');
global.FormData = require('form-data');

var chai = require("chai");
var chaiAsPromised = require("chai-as-promised");

chai.use(chaiAsPromised);
var should = require('chai').should();

var HttpClient = require('./index');
var http = new HttpClient();


describe('测试https请求', function(done){
  it('should return 200 and parse json text to object', function(){
    return http.$getJson('https://p.jinhui365.com/currentTime').should.eventually.satisfy(function(obj){
      return obj.message.code == 0;
    }).notify(done);
  });
});


describe('测试json解析', function(done){
  it('should parse json text to object', function(){
    return http.$getJson('http://p.jinhui365.com/currentTime').should.eventually.satisfy(function(obj){
      return obj.message.code == 0;
    }).notify(done);
  });
});

// describe('测试post请求', function(done){
//   it('登陆成功', function(){
//     return http.$postJson('http://p.jinhui365.cn/login.decryption', {
//       uinfo: '11100006789',
//       password: '111111',
//       client: 'website'
//     }).should.eventually.satisfy(function(obj){
//       return obj.message.code == 0;
//     }).notify(done);
//   });
// });

describe('测试统一前缀设置', function(done){
  before(function() {
    http.$setUrlPrefix('http://p.jinhui365.com');
  });

  it('should add prefix for uri', function(){
    return http.$getUrl('GET', '/currentTime', {}).should.satisfy(function(obj){
      return obj == 'http://p.jinhui365.com/currentTime';
    });
  });
});


describe('测试单例', function(done){
  before(function() {
    HttpClient.$getDefaultClient('http://p.jinhui365.cn');
  });

  it('should return 200 and parse json text to object', function(){
    return HttpClient.$getDefaultClient().$getJson('/currentTime').should.eventually.satisfy(function(obj){
      return obj.message.code == 0;
    }).notify(done);
  });
});


describe('测试入参过滤器设置', function(){
  before(function() {
    http.$addParamsFilter({
      filterParams:function(params) {
        params = params || {};
        params.__addParam = 1;
        return params;
      }
    });

    http.$addParamsFilter({
      filterParams:function(params) {
        params = params || {};
        params.__addParam2 = 2;
        return params;
      }
    });
  });

  it('should handle get request', function(){
    return http.$getUrl('GET', 'http://p.jinhui365.com/currentTime', http.$getParams({})).should.satisfy(function(obj){
      return obj.indexOf('__addParam') > 0 && obj.indexOf('__addParam2') > 0;
    });
  });


  after(function() {
    http.$clearParamsFilter();
  });
});

describe('测试参数拼接', function(){
  it('url和params都有参数，拼接正确', function(){
    return http.$getUrl('GET', 'http://p.jinhui365.com/currentTime?a=1', {b:2}).should.satisfy(function(obj){
      return obj == 'http://p.jinhui365.com/currentTime?a=1&b=2';
    });
  });

  it('只有params有参数，拼接正确', function(){
    return http.$getUrl('GET', 'http://p.jinhui365.com/currentTime', {b:2}).should.satisfy(function(obj){
      return obj == 'http://p.jinhui365.com/currentTime?b=2';
    });
  });

  it('只有url有参数，拼接正确', function(){
    return http.$getUrl('GET', 'http://p.jinhui365.com/currentTime?a=1').should.satisfy(function(obj){
      return obj == 'http://p.jinhui365.com/currentTime?a=1';
    });
  });

});

describe('测试filter替换', function(){

  it('应该使用第二个过滤器的参数', function(){
    var TestFilter = function(value) {
      this.value = value;
    };
    TestFilter.prototype.filterParams = function(params) {
      params = params || {};
      params.__addParam = this.value;
      return params;
    };
    var httpClient = new HttpClient(null, [new TestFilter("1")]);
    httpClient.$addParamsFilter(new TestFilter("2"));
    return httpClient.$getUrl('GET', 'http://p.jinhui365.com/currentTime?a=1', httpClient.$getParams({})).should.satisfy(function(obj){
      return obj == 'http://p.jinhui365.com/currentTime?a=1&__addParam=2';
    });
  });
});

describe('测试错误处理', function () {
  it('$getJson 非JSON返回值应该rejected', function(){
    return http.$getJson('https://www.baidu.com').should.be.rejected;
  });

  // it('不存在页面应该抛出异常', function(){
  //   return http.$get('http://p.jinhui365.cn/notexist').should.be.rejected;
  // })
});


