#!/bin/bash
#正则
infoReg="/passing|Error\:.Timeout|Error\:.timeout|HttpStatusError/"
resultReg="/[0-9]\)/"

#全局量
mails=("yli@rxhui.com" "xfwei@rxhui.com")
Info=info.log
TestError=TestError.log
TestWarn=TestWarn.log
outputDir=service_build_output

#错误标志变量
status=0

# 初始化
[ -f "$Info" ] && rm "$Info"
[ -f "$TestError" ] && rm "$TestError"
[ -f "$TestWarn" ] && rm "$TestWarn"
[ -d "$outputDir" ] && rm -rf "$outputDir"

# 测试输出日志，合并标准输出流和错误流
npm test > $Info 2>& 1

# 检查Info输出，标准输出流
cat $Info|awk '
BEGIN{RS="\n\n";infoCount=0;resultCount=0}
{
  if($0!=""){
    infoCount++;
    info[infoCount]=$0;
  }
  if($1~'$resultReg'){
    if($0~'$infoReg'){
      print $0>>"'$TestWarn'";
      i=0
      while(i<=infoCount){
        i++;
        if(match(info[i],$2)){
          print substr(info[i],length($2)+3)>>"'$TestWarn'";
          break;
        }
      }

      print "\n">>"'$TestWarn'";
    }else{
      resultCount++;
      result[resultCount]=$0;

      i=0
      while(i<=infoCount){
        i++;
        if(match(info[i],$2)){
          resultWithInfo[resultCount]=substr(info[i],length($2)+3);
          break;
        }
      }
    }
  }
}
END{
  i=0;
  while(i<resultCount){
    i++;
    print "##第"i"个错误测试用例\n---------------------------">>"'$TestError'";
    print result[i]>>"'$TestError'";
    print "该单元测试输出日志如下">>"'$TestError'";
    printf "%s", resultWithInfo[i]>>"'$TestError'";
    print "\n---------------------------">>"'$TestError'";
    print "\n">>"'$TestError'";
    print "\n">>"'$TestError'";
    
  }
}
'

# 创建日志文件夹，移动日志到该文件夹
[ ! -d "$outputDir" ] && mkdir "$outputDir"
[ -f "$Info" ] && mv "$Info" "./$outputDir"

# 错误日志分析
if [ -f "$TestError" ]; then
  echo 
  echo "测试错误原因:"
  cat $TestError
  echo
  mv "$TestError" "./$outputDir"
  status=1
fi

# 警告日志分析
if [ -f "$TestWarn" ]; then
  subject='node-http-service warn log'
  content=$(cat $TestWarn)
  if [ $status == 1 ]; then
    content=$"本次打包失败，请在Jenkins上查找失败原因。\n\n忽略错误如下\n\n"$content
  else
    content=$"本次打包成功，忽略如下错误\n\n"$content
  fi
  
  for item in ${mails[@]}
  do
    to_mail=${item}
    /usr/local/src/sendEmail-v1.56/sendEmail.pl -f jh365_zabbix@rxhui.com -t ${to_mail} -u ${subject} -m "$content" -o message-charset=utf-8 -s mail.rxhui.com -a ./${outputDir}/${Info}
  done
  
  mv "$TestWarn" "./$outputDir"
fi

if [ $status == 1 ]; then
  exit 1
fi